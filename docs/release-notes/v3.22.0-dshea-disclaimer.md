# Release Notes v3.22.0

**Release Date:** 2026-01-09

## DSHEA Disclaimer Controls & QA Gating

### Features

- **Disclaimer Applicability Column** - New `disclaimer_applicability` field (`SUPPLEMENT` or `TOPICAL`) determines whether DSHEA disclaimer is required. TOPICAL products (cosmetics, soaps) are now exempt from FDA disclaimer requirements.

- **Singular/Plural Prefix Selection** - New `choose_disclaimer_prefix(claim_count)` utility automatically selects correct DSHEA wording:
  - 1 claim → "This statement has not been evaluated..."
  - 2+ claims → "These statements have not been evaluated..."

- **QA Design Gate v2.4** - Updated `READY_FOR_DESIGN` audit to respect `disclaimer_applicability`. TOPICAL modules no longer fail design readiness checks due to missing `fda_disclaimer`.

### Database Changes

- Added `disclaimer_symbol` column (VARCHAR(8), default `*`)
- Added `disclaimer_applicability` column (VARCHAR(16), default `SUPPLEMENT`)
- CHECK constraint ensures only `SUPPLEMENT` or `TOPICAL` values
- Index on `disclaimer_applicability` for filtering performance
- Backfilled all 210 existing modules with defaults

### Migration Details

| Migration | Description |
|-----------|-------------|
| 003 | Add disclaimer_symbol + disclaimer_applicability columns |
| 004 | Fill fda_disclaimer for all SUPPLEMENT modules |

### Files Changed

- `app/shared/disclaimer.py` - New disclaimer utilities
- `app/qa/audit.py` - QA Design Gate v2.4
- `app/migrations/runner.py` - Migration endpoints 003+004
- `tests/test_disclaimer.py` - Comprehensive test coverage
- `migrations/003_disclaimer_columns.sql` - DDL migration

### Admin Operations

To mark cosmetic/topical products:

```sql
UPDATE os_modules_v3_1
SET disclaimer_applicability = 'TOPICAL',
    updated_at = NOW()
WHERE shopify_handle IN (
    'kojic-acid-turmeric-soap-maxima',
    'kojic-acid-turmeric-soap-maximo'
);
```

Verify distribution:
```sql
SELECT disclaimer_applicability, COUNT(*) 
FROM os_modules_v3_1 
GROUP BY 1;
```

### API Endpoints

| Endpoint | Status |
|----------|--------|
| `POST /api/v1/migrations/run/003-disclaimer-columns` | ✅ Deployed |
| `POST /api/v1/migrations/run/004-fill-fda-disclaimer` | ✅ Deployed |
| `GET /api/v1/migrations/status/003-disclaimer-columns` | ✅ Deployed |
| `GET /api/v1/migrations/status/004-fill-fda-disclaimer` | ✅ Deployed |
| `GET /api/v1/qa/audit/os-modules/design` | ✅ Updated v2.4 |

### Breaking Changes

None. All changes are backward compatible.

### Dependencies

No new dependencies added.
